@page "/view-recommendations"
@using Frontend.Components.Documents
@using Frontend.Components.Recommendation
@using Frontend.Contracts.Abstract_Services.AuditMissionService
@using Frontend.Contracts.Abstract_Services.InstitutionsService
@using Frontend.Contracts.Abstract_Services.Notification
@using Frontend.Contracts.Abstract_Services.RecommendationService
@using Frontend.EntityDtos.AuditMission
@using Frontend.EntityDtos.Notification
@using Frontend.EntityViewModels.Recommendation
@using Microsoft.AspNetCore.WebUtilities
@using Orientation = Radzen.Orientation

@inject IAuditMissionService _auditMissionService
@inject IRecommendationService _recommendationService
@inject DialogService _dialogService
@inject NotificationService _notificationService
@inject IAuditNotificationService _auditNotificationService
@inject IInstitutionService _institutionService
@inject NavigationManager _navigationManager

<RadzenStack Orientation="Orientation.Vertical">

    @*Select audit mission to see recommendations*@
    <RadzenStack Orientation="Orientation.Horizontal">
        <RadzenDropDown
            Data="_auditMissions"
            TValue="Guid"
            TextProperty="Name"
            ValueProperty="Id"
            Value="_selectedAuditMissionId"
            ValueChanged="@((value) => FetchRecommendations(value))"/>


    </RadzenStack>

    <RadzenCard Variant="Variant.Outlined">
        <RadzenStack Orientation="Orientation.Vertical">
            <RadzenDataGrid
                @ref="_dataGrid"
                Data="_recommendations"
                TItem="BaseRecommendationViewModel"
                AllowFiltering="true"
                AllowPaging="true"
                PageSize="5"
                AllowSorting="true"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowColumnResize="true">
                <Columns>

                    <RadzenDataGridColumn Title="Name" Property="Description"/>
                    <RadzenDataGridColumn Title="Due Date" Property="DueDate"/>
                    <RadzenDataGridColumn Title="Status" Property="Status"/>
                    <RadzenDataGridColumn Title="Problem" Property="Problem"/>
                    <RadzenDataGridColumn >
                        <Template Context="recommendation">
                            <RadzenStack JustifyContent="JustifyContent.Center" Orientation="Orientation.Vertical">
                                <RadzenButton Icon="upload" Click="@(() => UploadDocument(recommendation))" ButtonStyle="ButtonStyle.Secondary" Text="Upload Document"></RadzenButton>
                                <RadzenButton Icon="update" Click="@(() => UpdateStatus(recommendation))" ButtonStyle="ButtonStyle.Warning" Text="Change Status"></RadzenButton>
                            </RadzenStack>

                        </Template>
                    </RadzenDataGridColumn>
                </Columns>

            </RadzenDataGrid>


        </RadzenStack>


    </RadzenCard>


</RadzenStack>


@code {
    private RadzenDataGrid<BaseRecommendationViewModel> _dataGrid;

    private List<BaseAuditMissionDto> _auditMissions = [];

    private List<BaseRecommendationViewModel> _recommendations = [];

    private Guid _selectedAuditMissionId = Guid.Empty;

    private string? auditMissionQueryParameter = null;


}


@functions
{
    protected override async Task OnParametersSetAsync()
    {
        await FetchQueryParams();
        if(auditMissionQueryParameter!= null)
        {
            _selectedAuditMissionId = Guid.Parse(auditMissionQueryParameter);
            await FetchRecommendations(_selectedAuditMissionId);
        }
        await FetchUserAuditMission();
    }

    private async Task FetchUserAuditMission()
    {
        var response = await _auditMissionService.GetAuditMissionsByUserInstitution();

        if (response.Success)
        {
            _auditMissions = response.DtoResponses;
        }
        else
        {
            //Handle error
        }
    }

    private async Task FetchQueryParams()
    {
        var uri = _navigationManager.Uri;
        //get the query string parameters
        var queryDictionary = QueryHelpers.ParseQuery(new Uri(uri).Query);
        string?  auditMissionId = null;
        //get the institutionId parameter
        if (queryDictionary.TryGetValue("auditMissionId", out var missionId))
        {
            var value = missionId.FirstOrDefault();
            if (!String.IsNullOrEmpty(value))
            {
                //use the institutionId
                auditMissionQueryParameter = value;
            }

        }


    }

    private async Task FetchRecommendations(Guid value)
    {
        var response = await _recommendationService.FindAllByAuditMissionIdAsync(value);


        if (response.Success)
        {
            _recommendations = response.DtoResponses;
        }
        else
        {
            //Handle error
        }
    }

    private async Task UploadDocument(BaseRecommendationViewModel recommendation)
    {
        //open a dialog to upload document for that recommendation
        _dialogService.Open<AttachDocumentToRecommendationComponent>(
            "Upload Document",
            new Dictionary<string, object>()
            {
                { "Recommendation", recommendation }
            },
            new DialogOptions() { Width = "60%", Height = "70%" }
        );


        //send a notification to the audit team that a document has been uploaded
    }

    private async Task OnStatusChanged(BaseRecommendationViewModel recommendation)
    {
        //update the status of the recommendation
        _recommendations.First(x => x.Id == recommendation.Id).Status = recommendation.Status;
        await _dataGrid.Reload();
    }

    private Task UpdateStatus(BaseRecommendationViewModel recommendation)
    {
        //open a dialog to update the status of the recommendation
        _dialogService.Open<SelectRecommendationStatusComponent>(
            "Update Status",
            new Dictionary<string, object>()
            {
                { "recommendation", recommendation },
                { "OnStatusChanged", new EventCallback<BaseRecommendationViewModel>(this, OnStatusChanged) }

            },
            new DialogOptions() { Width = "40%", Height = "40%" }
        );

        return Task.CompletedTask;
    }
}