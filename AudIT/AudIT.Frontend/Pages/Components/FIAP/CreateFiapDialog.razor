@using Frontend.Contracts.Abstract_Services.FiapService
@using Frontend.EntityDtos.Fiap
@using Frontend.EntityViewModels.Fiap
@using Orientation = Radzen.Orientation
@using ButtonType = Radzen.ButtonType
@inject NotificationService _notificationService
@inject DialogService _dialogService
@inject IFiapService _fiapService
<RadzenCard Variant="Variant.Outlined">
    <RadzenRow class="rz-mb-4">
        <RadzenText Text="Create Fiap" TextStyle="TextStyle.H4"></RadzenText>
    </RadzenRow>
    <RadzenTemplateForm On Submit="@CreateFiap" Data="CreateFiapDto" TItem="@BaseCreateFiapDto">
        <RadzenRow JustifyContent="JustifyContent.Left">
            <RadzenColumn>
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenLabel Text="Start Date:" Component="forStart"></RadzenLabel>
                    <RadzenDatePicker @bind-Value="@CreateFiapDto.AuditedPeriodStart" Name="forStart" Placeholder="Start Date:"></RadzenDatePicker>
                    <RadzenRequiredValidator Text="Field is required " Component="forStart"></RadzenRequiredValidator>
                    <RadzenLabel Text="End Date:" Component="forEnd"></RadzenLabel>
                    <RadzenDatePicker @bind-Value="@CreateFiapDto.AuditedPeriodEnd" Name="forEnd" Placeholder="Start Date:"></RadzenDatePicker>
                    <RadzenRequiredValidator Text="Field is required " Component="forEnd"></RadzenRequiredValidator>
                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn>
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenLabel Text="Name:" Component="forName"></RadzenLabel>
                    <RadzenTextBox @bind-Value="@CreateFiapDto.Name" Placeholder="Name..." Name="forName"></RadzenTextBox>
                    <RadzenRequiredValidator Text="Name is required " Component="forName"></RadzenRequiredValidator>

                    <RadzenLabel Text="Problem:" Component="forProblem"></RadzenLabel>
                    <RadzenTextBox @bind-Value="@CreateFiapDto.Problem" Placeholder="Problem..." Name="forProblem"></RadzenTextBox>
                    <RadzenRequiredValidator Text="Problem is required " Component="forProblem"></RadzenRequiredValidator>


                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow JustifyContent="JustifyContent.SpaceAround" class="rz-my-10">


            <RadzenStack Orientation="Orientation.Vertical">
                <RadzenStack Orientation="Orientation.Horizontal">
                    <RadzenStack Orientation="Orientation.Vertical">


                        <RadzenLabel Text="Cause:" Component="forCause"></RadzenLabel>
                        <RadzenTextBox @bind-Value="@CreateFiapDto.Cause" Placeholder="Cause..." Name="forCause"></RadzenTextBox>
                        <RadzenRequiredValidator Component="forCause" Text="Cause is required!"></RadzenRequiredValidator>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Vertical">
                        <RadzenLabel Text="Consequence:" Component="forConsequence"></RadzenLabel>
                        <RadzenTextBox @bind-Value="@CreateFiapDto.Consequence" Placeholder="Consequence..." Name="forConsequence"></RadzenTextBox>
                        <RadzenRequiredValidator Text="Consequence is required " Component="forConsequence"></RadzenRequiredValidator>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Vertical">
                        <RadzenLabel Text="Additional findings:" Component="forFindings"></RadzenLabel>
                        <RadzenTextBox @bind-Value="@CreateFiapDto.AditionalFindings" Placeholder="Additional findings..." Name="forFindings"></RadzenTextBox>
                        <RadzenRequiredValidator Text="Field is required " Component="forFindings"></RadzenRequiredValidator>
                    </RadzenStack>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenLabel Text="Recommendation:"></RadzenLabel>
                    <RadzenTextArea @bind-Value="@CreateFiapDto.Recommendation" Placeholder="Recommendation..." Name="forRecommendation"></RadzenTextArea>
                </RadzenStack>
                <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Text="Submit"></RadzenButton>
                <RadzenButton Click="@Cancel" ButtonStyle="ButtonStyle.Dark" Text="Cancel"></RadzenButton>
            </RadzenStack>


        </RadzenRow>
    </RadzenTemplateForm>
</RadzenCard>


@code {

    private BaseCreateFiapDto CreateFiapDto { get; set; } = new BaseCreateFiapDto();


    //
    [Parameter] public EventCallback<BaseObjActionFiapViewmodel> OnFiapDialogClose { get; set; }

    [Parameter] public Guid AuditMissionId { get; set; }

    [Parameter] public Guid ObjectiveActionId { get; set; }


}


@functions
{
    private Task Cancel()
    {
        _dialogService.Close();

        return Task.CompletedTask;
    }

    private async Task CreateFiap()
    {
        CreateFiapDto.AuditMissionId = AuditMissionId;
        CreateFiapDto.ObjectiveActionId = ObjectiveActionId;

        var response = await _fiapService.CreateFiapAsync(CreateFiapDto);

        if (response.Success)
        {
            _notificationService.Notify(NotificationSeverity.Success, "Success", "Fiap created successfully");
            _dialogService.Close(null);
            await OnFiapDialogClose.InvokeAsync(response.DtoResponse);
        }

        else
        {
            _notificationService.Notify(NotificationSeverity.Error, "Error", "Fiap creation failed");
            //create a new
            _dialogService.Close(null);
        }
    }

}